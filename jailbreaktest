--[[
    FINAL FIXED SCRIPT
    UI: Fluent
    Logic: Smile B + Aoi Robberies
    Status: Loader Fixed, Debug Added
]]

print("[SmileB] Script Initialization Started...")

if not game:IsLoaded() then
    print("[SmileB] Waiting for game to load...")
    game.Loaded:Wait()
end

-- // 1. LOAD UI LIBRARY // --
print("[SmileB] Attempting to load Fluent UI Library...")

local Fluent = nil
local SaveManager = nil
local InterfaceManager = nil

local function LoadComponent(url, name)
    print("[SmileB] Downloading " .. name .. "...")
    local success, result = pcall(function()
        return game:HttpGet(url)
    end)
    
    if not success then
        warn("[SmileB] Failed to download " .. name .. "! Error: " .. tostring(result))
        return nil
    end
    
    local func, err = loadstring(result)
    if not func then
        warn("[SmileB] Failed to compile " .. name .. "! Error: " .. tostring(err))
        return nil
    end
    
    print("[SmileB] " .. name .. " loaded successfully.")
    return func()
end

-- Load Fluent (Main)
Fluent = LoadComponent("https://github.com/dawid-scripts/Fluent/releases/latest/download/main.lua", "Fluent")
-- Load Addons
SaveManager = LoadComponent("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/SaveManager.lua", "SaveManager")
InterfaceManager = LoadComponent("https://raw.githubusercontent.com/dawid-scripts/Fluent/master/Addons/InterfaceManager.lua", "InterfaceManager")

if not Fluent then
    game.StarterGui:SetCore("SendNotification", {
        Title = "SmileB Error",
        Text = "Critical: UI Library failed to load. Check F9 Console.",
        Duration = 10
    })
    return -- Stop execution if UI is missing
end

-- // 2. SETUP SERVICES // --
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera

-- // 3. CONFIG & STATE // --
local DEFAULT_KILL_RANGE = 1000
local KILLAURA_TICK = 0.22
local GIVEITEM_ATTEMPT_DELAY = 0.18
local GIVEITEM_MAX_ATTEMPTS = 5000
local DAMAGE_PRIORITY_WINDOW = 3
local LOG_CAP = 50
local ESP_UPDATE_INTERVAL = 0.1
local PISTOL_CHECK_INTERVAL = 0.5
local EQUIP_WAIT_TIME = 0.12
local FIRE_DELAY = 0.06

local state = {
    keyBypass = false,
    esp = false,
    killAura = false,
    silentAim = false,
    killRange = DEFAULT_KILL_RANGE,
    silentAimRange = DEFAULT_KILL_RANGE,
    hasPistol = false,
    tryingToGetPistol = false,
    killLoopId = 0,
    currentTarget = nil,
    localSpeed = 24,
    infJump = false,
    nerfEquip = false,
    antiRagdoll = false,
    npcAura = false,
    hitbox = false,
    teleportAbortRequested = false,
    policeIndicator = false,
    policeRange = 650
}

local logs = {}
local lastHealth = nil
local lastDamageTime = 0
local lastDamagePosition = nil
local RayCastModule = nil
local oldRayIgnore = nil

-- // 4. PRE-LOAD MODULES // --
task.spawn(function()
    pcall(function()
        if ReplicatedStorage:FindFirstChild("Module") and ReplicatedStorage.Module:FindFirstChild("RayCast") then
            RayCastModule = require(ReplicatedStorage.Module.RayCast)
            oldRayIgnore = RayCastModule and RayCastModule.RayIgnoreNonCollideWithIgnoreList
            print("[SmileB] RayCast module hooked successfully.")
        end
    end)
end)

-- // 5. BUILD UI // --
print("[SmileB] Building Window...")

local Window = Fluent:CreateWindow({
    Title = "Jailbreak | Smile B",
    SubTitle = "Merged Version",
    TabWidth = 160,
    Size = UDim2.fromOffset(580, 460),
    Acrylic = true,
    Theme = "Dark",
    MinimizeKey = Enum.KeyCode.RightShift
})

local Tabs = {
    Main = Window:AddTab({ Title = "Main", Icon = "home" }),
    Teleport = Window:AddTab({ Title = "Teleport", Icon = "map-pin" }),
    LocalPlayer = Window:AddTab({ Title = "LocalPlayer", Icon = "user" }),
    Misc = Window:AddTab({ Title = "Misc", Icon = "align-justify" }),
    Robberies = Window:AddTab({ Title = "Robberies", Icon = "dollar-sign" }),
    Logs = Window:AddTab({ Title = "Logs", Icon = "file-text" }),
    Settings = Window:AddTab({ Title = "Settings", Icon = "settings" })
}

local Options = Fluent.Options

-- // LOGGING HELPER // --
local LogParagraph = Tabs.Logs:AddParagraph({
    Title = "Log History",
    Content = "Logs will appear here..."
})

local function pushLog(msg)
    local entry = ("[%s] %s"):format(os.date("%H:%M:%S"), tostring(msg))
    table.insert(logs, 1, entry)
    if #logs > LOG_CAP then table.remove(logs) end
    if LogParagraph then
        pcall(function() LogParagraph:SetDesc(table.concat(logs, "\n")) end)
    end
    print("[SmileB] " .. entry)
end

-- // HELPER FUNCTIONS // --

local function tryClickGiversOnce()
    if not Workspace:FindFirstChild("Givers") then return false end
    for _,g in ipairs(Workspace.Givers:GetChildren()) do
        if not g or not g.Parent then continue end
        local cd = g:FindFirstChildWhichIsA("ClickDetector")
        if cd then
            pcall(function() fireclickdetector(cd) end)
            task.wait(0.04)
            if LocalPlayer:FindFirstChild("Folder") and LocalPlayer.Folder:FindFirstChild("Pistol") then return true end
        end
    end
    return false
end

local function tryPickupDroppedOnce()
    local char = LocalPlayer.Character
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return false end
    local found = false
    for _,obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") and obj.Parent and obj.Parent:IsA("Model") then
            local name = tostring(obj.Name):lower()
            if string.find(name, "pistol") or string.find(name, "gun") or string.find(name, "rifle") or string.find(name, "shotgun") or string.find(name, "ammo") or string.find(name, "cash") or string.find(name, "money") or string.find(name, "bag") or string.find(name, "drop") then
                pcall(function()
                    for i = 1, 5 do
                        firetouchinterest(obj, hrp, 0)
                        task.wait(0.03)
                        firetouchinterest(obj, hrp, 1)
                        task.wait(0.05)
                    end
                end)
                found = true
                if LocalPlayer:FindFirstChild("Folder") and #LocalPlayer.Folder:GetChildren() > 0 then return true end
            end
        end
    end
    return found
end

function ensurePistol()
    if state.tryingToGetPistol or state.hasPistol then return end
    state.tryingToGetPistol = true
    pushLog("Pistol acquisition: scanning Givers...")
    task.spawn(function()
        local attempts = 0
        while not state.hasPistol and attempts < GIVEITEM_MAX_ATTEMPTS do
            pcall(tryClickGiversOnce)
            pcall(tryPickupDroppedOnce)
            attempts = attempts + 1
            if LocalPlayer:FindFirstChild("Folder") and LocalPlayer.Folder:FindFirstChild("Pistol") then
                state.hasPistol = true
                pushLog("Pistol obtained after " .. tostring(attempts) .. " attempts")
                break
            end
            task.wait(GIVEITEM_ATTEMPT_DELAY)
        end
        if not state.hasPistol then pushLog("Pistol acquisition: failed after attempts") end
        state.tryingToGetPistol = false
    end)
end

function grabAllItems()
    if state.tryingToGetPistol then pushLog("Already attempting to get items"); return end
    state.tryingToGetPistol = true
    pushLog("Item grabber: starting aggressive gather...")
    task.spawn(function()
        local startCount = LocalPlayer:FindFirstChild("Folder") and #LocalPlayer.Folder:GetChildren() or 0
        local attempts = 0
        while attempts < GIVEITEM_MAX_ATTEMPTS do
            pcall(tryClickGiversOnce)
            pcall(tryPickupDroppedOnce)
            attempts = attempts + 1
            local nowCount = LocalPlayer:FindFirstChild("Folder") and #LocalPlayer.Folder:GetChildren() or 0
            if nowCount > startCount then
                pushLog("Item grabber: new items obtained after " .. tostring(attempts) .. " attempts")
                break
            end
            task.wait(GIVEITEM_ATTEMPT_DELAY)
        end
        if attempts >= GIVEITEM_MAX_ATTEMPTS then pushLog("Item grabber: finished with no new items") end
        state.tryingToGetPistol = false
    end)
end

local function teamString(pl)
    if not pl then return "" end
    return tostring(pl.Team)
end

local function isEnemyTeam(myTeam, theirTeam)
    if myTeam == "Police" then return theirTeam == "Criminal" end
    if myTeam == "Criminal" or myTeam == "Prisoner" then return theirTeam == "Police" end
    return myTeam ~= theirTeam
end

local function getNearestEnemy(maxRange)
    maxRange = maxRange or DEFAULT_KILL_RANGE
    local nearestDistance = maxRange
    local nearestEnemy = nil
    local myTeam = teamString(LocalPlayer)
    local priorityActive = (tick() - lastDamageTime) < DAMAGE_PRIORITY_WINDOW and lastDamagePosition
    local myPos = (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character.HumanoidRootPart.Position) or Vector3.new()
    for _,v in pairs(Players:GetPlayers()) do
        if v ~= LocalPlayer and v.Character and v.Character:FindFirstChild("HumanoidRootPart") and v.Character:FindFirstChild("Humanoid") and v.Character.Humanoid.Health > 0 then
            local theirTeam = teamString(v)
            if isEnemyTeam(myTeam, theirTeam) then
                local distToMyPos = (v.Character.HumanoidRootPart.Position - myPos).Magnitude
                local dist = distToMyPos
                if priorityActive then
                    local pdist = (v.Character.HumanoidRootPart.Position - lastDamagePosition).Magnitude
                    dist = pdist
                    if distToMyPos > maxRange then continue end
                end
                if dist < nearestDistance then
                    nearestDistance = dist
                    nearestEnemy = v
                end
            end
        end
    end
    return nearestEnemy
end

function updateOverrideState()
    if not RayCastModule then
        local ok, mod = pcall(function()
            if ReplicatedStorage:FindFirstChild("Module") and ReplicatedStorage.Module:FindFirstChild("RayCast") then
                return require(ReplicatedStorage.Module.RayCast)
            end
        end)
        if ok and mod then
            RayCastModule = mod
            oldRayIgnore = oldRayIgnore or RayCastModule.RayIgnoreNonCollideWithIgnoreList
            pushLog("RayCast module acquired on-demand")
        end
    end
    if not RayCastModule or not oldRayIgnore then return end
    if state.silentAim or state.killAura then
        RayCastModule.RayIgnoreNonCollideWithIgnoreList = function(...)
            local args = {oldRayIgnore(...)}
            if state.silentAim or state.killAura then
                local rangeToUse = state.silentAim and state.silentAimRange or state.killRange
                local nearestEnemy = getNearestEnemy(rangeToUse)
                local env = pcall(function() return getfenv(2) end) and getfenv(2) or nil
                local scriptName = env and tostring(env.script) or ""
                if (scriptName == "BulletEmitter" or scriptName == "Taser") and nearestEnemy and nearestEnemy.Character and nearestEnemy.Character:FindFirstChild("HumanoidRootPart") then
                    args[1] = nearestEnemy.Character.HumanoidRootPart
                    args[2] = nearestEnemy.Character.HumanoidRootPart.Position
                end
            end
            return unpack(args)
        end
        pushLog("Conditional override applied")
        ensurePistol()
    else
        pcall(function() RayCastModule.RayIgnoreNonCollideWithIgnoreList = oldRayIgnore end)
        pushLog("Override removed")
    end
end

function runKillAura(character)
    if not character then return end
    state.killLoopId = state.killLoopId + 1
    local myLoopId = state.killLoopId
    pushLog("KillAura loop started (id " .. tostring(myLoopId) .. ")")
    if not state.hasPistol then ensurePistol() end
    task.spawn(function()
        while true do
            if state.killLoopId ~= myLoopId then break end
            if not state.killAura then break end
            if not character or not character.Parent then break end
            local hrp = character:FindFirstChild("HumanoidRootPart")
            if not hrp then break end
            if not state.hasPistol then
                if not state.tryingToGetPistol then ensurePistol() end
                task.wait(KILLAURA_TICK)
            else
                local nearestEnemy = getNearestEnemy(state.killRange)
                if nearestEnemy then
                    if LocalPlayer:FindFirstChild("Folder") and LocalPlayer.Folder:FindFirstChild("Pistol") then
                        local shotCount = 0
                        pcall(function() LocalPlayer.Folder.Pistol.InventoryEquipRemote:FireServer(true) end)
                        task.wait(EQUIP_WAIT_TIME)
                        while state.killAura and nearestEnemy and nearestEnemy.Character and nearestEnemy.Character:FindFirstChild("HumanoidRootPart") and nearestEnemy.Character:FindFirstChild("Humanoid") and nearestEnemy.Character.Humanoid.Health > 0 and (nearestEnemy.Character.HumanoidRootPart.Position - hrp.Position).Magnitude < state.killRange do
                            local currentGun = nil
                            pcall(function() currentGun = require(ReplicatedStorage.Game.ItemSystem.ItemSystem).GetLocalEquipped() end)
                            if currentGun then
                                pcall(function() require(ReplicatedStorage.Game.Item.Gun)._attemptShoot(currentGun) end)
                                shotCount = shotCount + 1
                            end
                            task.wait(FIRE_DELAY)
                        end
                        pcall(function() LocalPlayer.Folder.Pistol.InventoryEquipRemote:FireServer(false) end)
                    end
                end
                task.wait(KILLAURA_TICK)
            end
        end
        pushLog("KillAura loop stopped")
    end)
end

local function stopActiveTeleport()
    state.teleportAbortRequested = true
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = LocalPlayer.Character.HumanoidRootPart
        if hrp:FindFirstChild("Vel") then pcall(function() hrp.Vel:Destroy() end) end
    end
    pushLog("Emergency teleport STOP requested")
end

local function teleportTo(pos)
    if not pos then return end
    state.teleportAbortRequested = false
    local plr = Players.LocalPlayer
    if not plr or not plr.Character or not plr.Character:FindFirstChild("HumanoidRootPart") then return end
    if plr.Character.HumanoidRootPart:FindFirstChild("Vel") then pcall(function() plr.Character.HumanoidRootPart.Vel:Destroy() end) end
    local function doTeleport(targetPos)
        if state.teleportAbortRequested then return end
        local hrp = plr.Character.HumanoidRootPart
        plr.Character.HumanoidRootPart.CFrame = plr.Character.HumanoidRootPart.CFrame + Vector3.new(0,3000,0)
        local vel = Instance.new("BodyVelocity", hrp)
        vel.MaxForce = Vector3.new(math.huge,math.huge,math.huge)
        vel.Name = "Vel"
        vel.P = 0
        local cood = targetPos + Vector3.new(0,3000,0)
        repeat
            task.wait()
            if state.teleportAbortRequested then
                vel:Destroy()
                plr.Character.HumanoidRootPart.CFrame = plr.Character.HumanoidRootPart.CFrame - Vector3.new(0,3000,0)
                return
            end
            vel.Velocity = CFrame.lookAt(hrp.Position,cood).LookVector * 50
        until (hrp.Position - cood).magnitude < 5
        vel.Velocity = Vector3.new(0,0,0)
        task.wait(.5)
        pcall(function() plr.Character.Humanoid.Sit = true end)
        vel:Destroy()
        plr.Character.HumanoidRootPart.CFrame = plr.Character.HumanoidRootPart.CFrame - Vector3.new(0,3000,0)
    end
    doTeleport(pos)
end

local function findClosestKeywordPosition(keywords)
    local hrp = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local bestPos, bestDist = nil, (1/0)
    for _,obj in ipairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") or obj:IsA("Model") then
            local name = tostring(obj.Name):lower()
            for _,kw in ipairs(keywords) do
                if string.find(name, kw) then
                    local pos
                    if obj:IsA("BasePart") then pos = obj.Position
                    else
                        if obj.PrimaryPart then pos = obj.PrimaryPart.Position
                        else
                            for _,d in ipairs(obj:GetDescendants()) do
                                if d:IsA("BasePart") then pos = d.Position; break end
                            end
                        end
                    end
                    if pos and hrp then
                        local dist = (pos - hrp.Position).magnitude
                        if dist < bestDist then bestDist = dist; bestPos = pos end
                    elseif pos and not hrp then
                        bestPos = pos; break
                    end
                    break
                end
            end
        end
    end
    return bestPos
end

local robberyTeleports = {
    {"Plane", Vector3.new(-1292.0791015625, 41.271751403808594, 2852.651611328125)},
    {"Power Plant", Vector3.new(54.766014099121094, 20.965660095214844, 2326.134765625)},
    {"Jeweler", Vector3.new(149.5464630126953, 17.965538024902344, 1368.3978271484375)},
    {"Criminal Base", Vector3.new(-295.552978515625, 17.965667724609375, 1602.01806640625)},
    {"City Bank", Vector3.new(-8.082767486572266, 17.965639114379883, 857.6124267578125)},
    {"Museum", Vector3.new(1123.495849609375, 139.15896606445312, 1293.735107421875)},
    {"1M Shop", Vector3.new(551.2893676757812, 63.955833435058594, -1647.752197265625)},
    {"Volcano", Vector3.new(2212.631591796875, 328.26995849609375, -2503.282958984375)},
    {"Casino", Vector3.new(-69.00199890136719, 154.98049926757812, -4707.578125)},
    {"Create Bank", Vector3.new(-749.2611694335938, 19.252309799194336, -5957.173828125)},
    {"OilRig", Vector3.new(-2838.67578125, 134.25027465820312, -3973.582275390625)}
}


-- // MAIN TAB // --

local KeyBypassToggle = Tabs.Main:AddToggle("KeycardBypass", {Title = "Keycard Bypass", Default = false })
KeyBypassToggle:OnChanged(function()
    state.keyBypass = KeyBypassToggle.Value
    local ok, plrUtils = pcall(function() return ReplicatedStorage:FindFirstChild("Game") and ReplicatedStorage.Game:FindFirstChild("PlayerUtils") end)
    if ok and plrUtils then
        if state.keyBypass then
            if not rawget(_G, "SmileB_original_hasKey") then pcall(function() rawset(_G, "SmileB_original_hasKey", require(plrUtils).hasKey) end) end
            pcall(function() require(plrUtils).hasKey = function() return true end end)
            pushLog("Keycard bypass enabled")
        else
            pcall(function() require(plrUtils).hasKey = rawget(_G, "SmileB_original_hasKey") or require(plrUtils).hasKey end)
            pushLog("Keycard bypass disabled")
        end
    else
        pushLog("Keycard bypass: PlayerUtils not found")
    end
end)
KeyBypassToggle:AddKeybind()

local KillAuraToggle = Tabs.Main:AddToggle("KillAura", {Title = "KillAura (Players)", Default = false })
KillAuraToggle:OnChanged(function()
    state.killAura = KillAuraToggle.Value
    pushLog("KillAura toggled: " .. tostring(state.killAura))
    if state.killAura and LocalPlayer.Character then
        task.spawn(function() runKillAura(LocalPlayer.Character) end)
    else
        state.killLoopId = state.killLoopId + 1
    end
    updateOverrideState()
end)
KillAuraToggle:AddKeybind()

local KillAuraRange = Tabs.Main:AddSlider("KillAuraRange", {
    Title = "KillAura Range", Description = "Range in studs", Default = DEFAULT_KILL_RANGE, Min = 100, Max = 5000, Rounding = 0,
    Callback = function(Value) state.killRange = Value end
})

local NPCAuraToggle = Tabs.Main:AddToggle("NPCAura", {Title = "NPC Aura (Guards/NPCs)", Default = false })
NPCAuraToggle:OnChanged(function()
    state.npcAura = NPCAuraToggle.Value
    pushLog("NPC Aura toggled: " .. tostring(state.npcAura))
end)

local SilentAimToggle = Tabs.Main:AddToggle("SilentAim", {Title = "Silent Aim", Default = false })
SilentAimToggle:OnChanged(function()
    state.silentAim = SilentAimToggle.Value
    pushLog("Silent Aim toggled: " .. tostring(state.silentAim))
    updateOverrideState()
    if state.silentAim then ensurePistol() end
end)
SilentAimToggle:AddKeybind()

local SilentAimRange = Tabs.Main:AddSlider("SilentAimRange", {
    Title = "Silent Aim Range", Description = "Range in studs", Default = DEFAULT_KILL_RANGE, Min = 100, Max = 5000, Rounding = 0,
    Callback = function(Value) state.silentAimRange = Value end
})

local ESPToggle = Tabs.Main:AddToggle("ESP", {Title = "ESP Master", Default = false })
ESPToggle:OnChanged(function()
    state.esp = ESPToggle.Value
    pushLog("ESP toggled: " .. tostring(state.esp))
    if state.esp then
        getgenv().ESPSettings.box = true
        getgenv().ESPSettings.chams = true
        getgenv().ESPSettings.tracers = true
        getgenv().ESPSettings.health = true
        getgenv().ESPSettings.distance = true
        getgenv().ESPAPI.Enable()
    else
        getgenv().ESPAPI.Disable()
    end
end)
ESPToggle:AddKeybind()

Tabs.Main:AddButton({
    Title = "Grab All Items",
    Callback = function() grabAllItems() end
})

-- // TELEPORT TAB // --

for _,t in ipairs(robberyTeleports) do
    Tabs.Teleport:AddButton({
        Title = t[1],
        Callback = function() task.spawn(function() teleportTo(t[2]) end) end
    })
end

Tabs.Teleport:AddButton({
    Title = "TP to Drop (if exists)",
    Callback = function()
        task.spawn(function()
            if Workspace:FindFirstChild("Drop") and Workspace.Drop:FindFirstChild("Root") then
                teleportTo(Workspace.Drop.Root.Position)
            else
                pushLog("Drop not found")
            end
        end)
    end
})

Tabs.Teleport:AddButton({
    Title = "TP Nearest Police Station",
    Callback = function()
        task.spawn(function()
            local keywords = {"police","policestation","cop","station","hq","command","squad"}
            local pos = findClosestKeywordPosition(keywords)
            if pos then 
                pushLog("Found nearest police station, teleporting")
                teleportTo(pos)
            else 
                pushLog("No police station found")
            end
        end)
    end
})

Tabs.Teleport:AddButton({
    Title = "Escape Prison",
    Callback = function()
        task.spawn(function()
            local keywords = {"prison","jail","cell","penitentiary","prison_exit","jail_exit","escape"}
            local pos = findClosestKeywordPosition(keywords)
            if pos then 
                pushLog("Found prison/jail area, teleporting")
                teleportTo(pos)
            else 
                pushLog("Prison area not found")
            end
        end)
    end
})

Tabs.Teleport:AddButton({
    Title = "EMERGENCY STOP TP",
    Description = "Halts any active teleport immediately",
    Callback = function() stopActiveTeleport() end
})

-- // LOCALPLAYER TAB // --

local WalkSpeedSlider = Tabs.LocalPlayer:AddSlider("WalkSpeed", {
    Title = "Walk Speed", Default = 24, Min = 0, Max = 200, Rounding = 0,
    Callback = function(Value) state.localSpeed = Value end
})

local InfJumpToggle = Tabs.LocalPlayer:AddToggle("InfJump", {Title = "Infinite Jump", Default = false })
InfJumpToggle:OnChanged(function()
    state.infJump = InfJumpToggle.Value
    pushLog("Inf Jump: " .. tostring(state.infJump))
end)

local NerfEquipToggle = Tabs.LocalPlayer:AddToggle("NerfEquip", {Title = "Nerf Equip (Cosmetic)", Default = false })
NerfEquipToggle:OnChanged(function()
    state.nerfEquip = NerfEquipToggle.Value
    pushLog("Nerf Equip: " .. tostring(state.nerfEquip))
end)

local AntiRagdollToggle = Tabs.LocalPlayer:AddToggle("AntiRagdoll", {Title = "Anti Ragdoll", Default = false })
AntiRagdollToggle:OnChanged(function()
    state.antiRagdoll = AntiRagdollToggle.Value
    pushLog("Anti Ragdoll: " .. tostring(state.antiRagdoll))
    task.spawn(function()
        local ok, tagUtils = pcall(function() return ReplicatedStorage:FindFirstChild("Tag") and require(ReplicatedStorage.Tag.TagUtils) end)
        if ok and tagUtils then
            if not rawget(_G, "SmileB_old_isPointInTag") then rawset(_G, "SmileB_old_isPointInTag", tagUtils.isPointInTag) end
            tagUtils.isPointInTag = function(point, tag)
                if tag == "NoRagdoll" or tag == "NoFallDamage" then
                    return state.antiRagdoll
                end
                return rawget(_G, "SmileB_old_isPointInTag")(point, tag)
            end
            pushLog("Anti Ragdoll patched TagUtils")
        else
            pushLog("Anti Ragdoll: TagUtils not found")
        end
    end)
end)

-- // MISC TAB // --

Tabs.Misc:AddButton({
    Title = "Load Vehicle Fly",
    Description = "T to toggle, H to boost",
    Callback = function()
        local ok, err = pcall(function()
            local _ = getgenv() or _G
            _["ToggleKey"] = "T"
            _["BoostKey"] = "H"
            _["BaseSpeed"] = 200
            _["BoostMultiplier"] = 2.3
            _["Acceleration"] = 5
            _["RotationSpeed"] = 10
            local url = "https://raw.githubusercontent.com/Smile-B14/Roblox/refs/heads/main/CarFly"
            local src = game:HttpGet(url)
            if src and #src > 10 then
                loadstring(src)()
            else
                error("CarFly script not found or empty at URL")
            end
        end)
        if ok then pushLog("Vehicle Fly script loaded") else pushLog("Vehicle Fly failed: " .. tostring(err)) end
    end
})

Tabs.Misc:AddButton({
    Title = "Open Gun Shop UI",
    Callback = function()
        local ok, uiModule = pcall(function() return require(ReplicatedStorage.Game.GunShop.GunShopUI) end)
        if ok and uiModule and uiModule.open then
            pcall(function() uiModule.open() end)
            pushLog("GunShop UI open attempted")
        else
            pushLog("GunShop UI not available")
        end
    end
})

Tabs.Misc:AddButton({
    Title = "No Wait E",
    Description = "Reduce CircleAction duration",
    Callback = function()
        local ok, UI = pcall(function() return require(ReplicatedStorage.Module:WaitForChild("UI")) end)
        if ok and UI and UI.CircleAction and UI.CircleAction.Specs then
            for i,v in pairs(UI.CircleAction.Specs) do
                pcall(function() v.Duration = 0; v.Timed = true end)
            end
            pushLog("No wait E applied")
        else
            pushLog("No wait E failed")
        end
    end
})

Tabs.Misc:AddButton({
    Title = "Delete Doors & Lasers",
    Description = "Disable collisions/touch",
    Callback = function()
        task.spawn(function()
            for _, v in ipairs(Workspace:GetDescendants()) do
                pcall(function()
                    if v.Name == "BarbedWire" or (v.Name == "Door" and v:IsA("Part")) or (v:IsA("Part") and v:FindFirstChild("TouchInterest") and v.BrickColor == BrickColor.new("Dusty Rose")) or (v.Name == "Part" and v:FindFirstChild("TouchInterest")) then
                        if pcall(function() v.CanTouch = false end) then end
                        if pcall(function() v.CanCollide = false end) then end
                        if pcall(function() v.Transparency = 1 end) then end
                    end
                    if v.Name == "SlideDoor" or v.Name == "SwingDoor" or v.Name == "Doors" or v.Name == "BankDoor" then
                        for _, f in ipairs(v:GetDescendants()) do
                            if f:IsA("Part") or f:IsA("MeshPart") then
                                pcall(function() f.CanCollide = false end)
                                pcall(function() f.Transparency = 1 end)
                            end
                        end
                    end
                end)
            end
            pushLog("Delete Doors & Lasers executed")
        end)
    end
})

local PoliceIndicatorToggle = Tabs.Misc:AddToggle("PoliceIndicator", {Title = "Police Nearby Indicator", Default = false })
PoliceIndicatorToggle:OnChanged(function()
    state.policeIndicator = PoliceIndicatorToggle.Value
    pushLog("Police Indicator: " .. tostring(state.policeIndicator))
end)

local PoliceRangeSlider = Tabs.Misc:AddSlider("PoliceRange", {
    Title = "Police Indicator Range", Default = 650, Min = 100, Max = 5000, Rounding = 0,
    Callback = function(Value) state.policeRange = Value end
})

-- // ROBBERIES TAB (AOI CODE) // --

local vu3 = Workspace

Tabs.Robberies:AddSection("Tomb")
local vu85 = {}
Tabs.Robberies:AddToggle("RemoveSpikes", {
    Title = "Remove Spikes", Default = false,
    Callback = function(p86)
        local v87 = vu3:FindFirstChild("RobberyTomb"):FindFirstChild("SpikeRoom")
        local v88 = v87 and v87:FindFirstChild("Spikes")
        if v88 then
            if p86 then
                vu85 = {}
                local v89, v90, v91 = pairs(v88:GetChildren())
                while true do
                    local v92
                    v91, v92 = v89(v90, v91)
                    if v91 == nil then break end
                    if v92:IsA("Model") then
                        local v93, v94, v95 = pairs(v92:GetChildren())
                        while true do
                            local v96
                            v95, v96 = v93(v94, v95)
                            if v95 == nil then break end
                            if v96:IsA("Model") and v96.Name == "Tile" then
                                local v97, v98, v99 = pairs(v96:GetChildren())
                                while true do
                                    local v100
                                    v99, v100 = v97(v98, v99)
                                    if v99 == nil then break end
                                    if v100:IsA("Model") and v100.Name == "Model" then
                                        table.insert(vu85, {v100:Clone(), v96})
                                        v100:Destroy()
                                    end
                                end
                            end
                        end
                    end
                end
            else
                local v101, v102, v103 = pairs(vu85)
                while true do
                    local v104
                    v103, v104 = v101(v102, v103)
                    if v103 == nil then break end
                    v104[1].Parent = v104[2]
                end
                vu85 = {}
            end
        end
    end
})

local vu105 = {}
Tabs.Robberies:AddToggle("DeleteDarts", {
    Title = "Remove Darts", Default = false,
    Callback = function(p106)
        local v107 = vu3:FindFirstChild("RobberyTomb"):FindFirstChild("DartRoom")
        local v108 = v107 and v107:FindFirstChild("Darts")
        if v108 then
            if p106 then
                vu105 = {}
                local v109, v110, v111 = pairs(v108:GetChildren())
                while true do
                    local v112
                    v111, v112 = v109(v110, v111)
                    if v111 == nil then break end
                    if v112:IsA("BasePart") then
                        table.insert(vu105, v112:Clone())
                        v112:Destroy()
                    end
                end
            else
                local v113, v114, v115 = pairs(vu105)
                while true do
                    local v116
                    v115, v116 = v113(v114, v115)
                    if v115 == nil then break end
                    v116.Parent = v108
                end
                vu105 = {}
            end
        end
    end
})

local vu117 = {}
local function vu121()
    local v118 = vu3:FindFirstChild("RobberyTomb")
    if v118 then
        local v119 = v118:FindFirstChild("Cart")
        local v120 = v119 and v119:FindFirstChild("Planks")
        if v120 then
            table.insert(vu117, { model = v120:Clone(), parent = v120.Parent })
            v120:Destroy()
        end
    end
end
local function vu126()
    local v122, v123, v124 = ipairs(vu117)
    while true do
        local v125
        v124, v125 = v122(v123, v124)
        if v124 == nil then break end
        if v125.model.Parent == nil then v125.model.Parent = v125.parent end
    end
    vu117 = {}
end
Tabs.Robberies:AddToggle("RemovePlanks", {
    Title = "Remove Planks", Default = false,
    Callback = function(p127) if p127 then vu121() else vu126() end end
})

local vu128 = {}
local function vu131()
    local v129 = vu3:FindFirstChild("RobberyTomb")
    local v130 = v129 and v129:FindFirstChild("Kill")
    if v130 then
        table.insert(vu128, { model = v130:Clone(), parent = v130.Parent })
        v130:Destroy()
    end
end
local function vu136()
    local v132, v133, v134 = ipairs(vu128)
    while true do
        local v135
        v134, v135 = v132(v133, v134)
        if v134 == nil then break end
        if v135.model.Parent == nil then v135.model.Parent = v135.parent end
    end
    vu128 = {}
end
Tabs.Robberies:AddToggle("RemoveKillModel", {
    Title = "Remove Lava Damage", Default = false,
    Callback = function(p137) if p137 then vu131() else vu136() end end
})

Tabs.Robberies:AddSection("PowerPlant")
local vu138 = {}
local function vu149(p139)
    local v140, v141, v142 = pairs(p139:GetChildren())
    while true do
        while true do
            local v143
            v142, v143 = v140(v141, v142)
            if v142 == nil then return end
            if not v143:IsA("Model") or v143.Name ~= "Model" then break end
            local v144, v145, v146 = pairs(v143:GetDescendants())
            local v147 = false
            while true do
                local v148
                v146, v148 = v144(v145, v146)
                if v146 == nil then break end
                if v148:IsA("BasePart") and v148.Name == "BarbedWire" then v147 = true break end
            end
            if v147 then
                table.insert(vu138, v143:Clone())
                v143:Destroy()
            end
        end
        vu149(v143)
    end
end
Tabs.Robberies:AddToggle("RemoveBarbedWireModel", {
    Title = "Remove Lasers", Default = false,
    Callback = function(p150)
        if p150 then
            vu149(workspace)
        else
            local v151, v152, v153 = pairs(vu138)
            while true do
                local v154
                v153, v154 = v151(v152, v153)
                if v153 == nil then break end
                v154.Parent = workspace
            end
            vu138 = {}
        end
    end
})

Tabs.Robberies:AddSection("Bank")
local vu155 = {}
local function vu161(p156)
    local v157, v158, v159 = pairs(p156:GetChildren())
    while true do
        local v160
        v159, v160 = v157(v158, v159)
        if v159 == nil then break end
        if v160:IsA("Model") and v160.Name == "Lasers" then
            table.insert(vu155, v160:Clone())
            v160:Destroy()
        else
            vu161(v160)
        end
    end
end
Tabs.Robberies:AddToggle("RemoveLasersBank1", {
    Title = "Remove 1st city Bank Lasers", Default = false,
    Callback = function(p162)
        local v163 = workspace:FindFirstChild("Banks")
        local v164 = v163 and v163:FindFirstChild("Bank")
        if v164 then
            if p162 then
                vu161(v164)
            else
                local v165, v166, v167 = pairs(vu155)
                while true do
                    local v168
                    v167, v168 = v165(v166, v167)
                    if v167 == nil then break end
                    v168.Parent = v164
                end
                vu155 = {}
            end
        end
    end
})
local vu169 = {}
local function vu175(p170)
    local v171, v172, v173 = pairs(p170:GetChildren())
    while true do
        local v174
        v173, v174 = v171(v172, v173)
        if v173 == nil then break end
        if v174:IsA("Model") and v174.Name == "Lasers" then
            table.insert(vu169, v174:Clone())
            v174:Destroy()
        else
            vu175(v174)
        end
    end
end
Tabs.Robberies:AddToggle("RemoveBank2Lasers", {
    Title = "Remove 2nd city Bank Lasers", Default = false,
    Callback = function(p176)
        local v177 = workspace:FindFirstChild("Banks")
        if v177 then
            local v178 = v177:FindFirstChild("Bank2")
            local v179 = v178 and v178:FindFirstChild("Layout")
            if v179 then
                if p176 then
                    vu175(v179)
                else
                    local v180, v181, v182 = pairs(vu169)
                    while true do
                        local v183
                        v182, v183 = v180(v181, v182)
                        if v182 == nil then break end
                        v183.Parent = v179
                    end
                    vu169 = {}
                end
            end
        end
    end
})

Tabs.Robberies:AddSection("Casino")
local vu184 = {}
local function vu191(p185, p186)
    local v187, v188, v189 = pairs(p185:GetChildren())
    while true do
        local v190
        v189, v190 = v187(v188, v189)
        if v189 == nil then break end
        if v190:IsA("Model") and table.find(p186, v190.Name) then
            vu184[v190.Name] = v190:Clone()
            v190:Destroy()
        else
            vu191(v190, p186)
        end
    end
end
local function vu196()
    local v192, v193, v194 = pairs(vu184)
    while true do
        local v195
        v194, v195 = v192(v193, v194)
        if v194 == nil then break end
        v195.Parent = workspace
    end
    vu184 = {}
end
Tabs.Robberies:AddToggle("RemoveCasinoModels", {
    Title = "Remove Lasers", Default = false,
    Callback = function(p197)
        if p197 then
            vu191(workspace, {"Lasers", "CamerasMoving", "LaserCarousel", "LasersMoving", "VaultLaserControl"})
        else
            vu196()
        end
    end
})

Tabs.Robberies:AddSection("Museum")
local vu198 = nil
local function vu202(p199)
    local v200 = p199:FindFirstChild("Museum")
    local v201 = v200 and v200:FindFirstChild("Lights")
    if v201 then
        vu198 = v201:Clone()
        v201:Destroy()
    end
end
local function vu203()
    if vu198 then
        vu198.Parent = workspace.Museum
        vu198 = nil
    end
end
Tabs.Robberies:AddToggle("RemoveMuseumLaser", {
    Title = "Remove Lasers", Default = false,
    Callback = function(p204) if p204 then vu202(workspace) else vu203() end end
})

Tabs.Robberies:AddSection("Mansion")
local vu205 = {}
local vu206 = {}
local vu207 = {}
local vu208 = {}
local vu209 = {}
local function vu220()
    local v210 = vu3:FindFirstChild("MansionDecorative")
    if v210 then
        local v211, v212, v213 = pairs(v210:GetDescendants())
        while true do
            local v214
            v213, v214 = v211(v212, v213)
            if v213 == nil then break end
            if v214:IsA("BasePart") and v214.Name == "BarbedWire" then
                table.insert(vu205, { part = v214:Clone(), parent = v214.Parent })
                v214:Destroy()
            end
        end
    end
    local v215 = vu3
    local v216, v217, v218 = pairs(v215:GetChildren())
    while true do
        local v219
        v218, v219 = v216(v217, v218)
        if v218 == nil then break end
        if v219:IsA("BasePart") and v219.Name == "BarbedWire" then
            table.insert(vu205, { part = v219:Clone(), parent = v219.Parent })
            v219:Destroy()
        end
    end
end
local function vu225()
    local v221, v222, v223 = ipairs(vu205)
    while true do
        local v224
        v223, v224 = v221(v222, v223)
        if v223 == nil then break end
        if v224.part.Parent == nil then v224.part.Parent = v224.parent end
    end
    vu205 = {}
end
local function vu228()
    local v226 = vu3:FindFirstChild("MansionRobbery")
    local v227 = v226 and v226:FindFirstChild("Lasers")
    if v227 then
        table.insert(vu206, { model = v227:Clone(), parent = v227.Parent })
        v227:Destroy()
    end
end
local function vu233()
    local v229, v230, v231 = ipairs(vu206)
    while true do
        local v232
        v231, v232 = v229(v230, v231)
        if v231 == nil then break end
        if v232.model.Parent == nil then v232.model.Parent = v232.parent end
    end
    vu206 = {}
end
local function vu236()
    local v234 = vu3:FindFirstChild("MansionRobbery")
    local v235 = v234 and v234:FindFirstChild("LaserTraps")
    if v235 then
        table.insert(vu207, { model = v235:Clone(), parent = v235.Parent })
        v235:Destroy()
    end
end
local function vu241()
    local v237, v238, v239 = ipairs(vu207)
    while true do
        local v240
        v239, v240 = v237(v238, v239)
        if v239 == nil then break end
        if v240.model.Parent == nil then v240.model.Parent = v240.parent end
    end
    vu207 = {}
end
local function vu244()
    local v242 = vu3:FindFirstChild("MansionRobbery")
    local v243 = v242 and v242:FindFirstChild("GuardsFolder")
    if v243 then
        table.insert(vu208, { folder = v243:Clone(), parent = v243.Parent })
        v243:Destroy()
    end
end
local function vu249()
    local v245, v246, v247 = ipairs(vu208)
    while true do
        local v248
        v247, v248 = v245(v246, v247)
        if v247 == nil then break end
        if v248.folder.Parent == nil then v248.folder.Parent = v248.parent end
    end
    vu208 = {}
end
local function vu252()
    local v250 = vu3:FindFirstChild("MansionRobbery")
    local v251 = v250 and v250:FindFirstChild("Shields")
    if v251 then
        table.insert(vu209, { model = v251:Clone(), parent = v251.Parent })
        v251:Destroy()
    end
end
local function vu257()
    local v253, v254, v255 = ipairs(vu209)
    while true do
        local v256
        v255, v256 = v253(v254, v255)
        if v255 == nil then break end
        if v256.model.Parent == nil then v256.model.Parent = v256.parent end
    end
    vu209 = {}
end
Tabs.Robberies:AddToggle("RemoveBarbedWireAndLasers", {
    Title = "Remove Lasers", Default = false,
    Callback = function(p258) if p258 then vu220() vu228() else vu225() vu233() end end
})
Tabs.Robberies:AddToggle("RemoveLaserTraps", {
    Title = "Remove Laser Traps", Default = false,
    Callback = function(p259) if p259 then vu236() else vu241() end end
})
Tabs.Robberies:AddToggle("RemoveGuardsFolder", {
    Title = "Remove NPCs", Default = false,
    Callback = function(p260) if p260 then vu244() else vu249() end end
})
Tabs.Robberies:AddToggle("RemoveShields", {
    Title = "Remove CEO Walls", Default = false,
    Callback = function(p261) if p261 then vu252() else vu257() end end
})

Tabs.Robberies:AddSection("Oil Rig")
local vu262 = {}
local function vu265()
    local v263 = vu3:FindFirstChild("OilRig")
    local v264 = v263 and v263:FindFirstChild("GuardsFolder")
    if v264 then
        table.insert(vu262, { folder = v264:Clone(), parent = v264.Parent })
        v264:Destroy()
    end
end
local function vu270()
    local v266, v267, v268 = ipairs(vu262)
    while true do
        local v269
        v268, v269 = v266(v267, v268)
        if v268 == nil then break end
        if v269.folder.Parent == nil then v269.folder.Parent = v269.parent end
    end
    vu262 = {}
end
Tabs.Robberies:AddToggle("RemoveGuardsFolderOil", {
    Title = "Remove NPCs", Default = false,
    Callback = function(p271) if p271 then vu265() else vu270() end end
})
local vu272 = {}
local function vu275()
    local v273 = vu3:FindFirstChild("OilRig")
    local v274 = v273 and v273:FindFirstChild("MovingLasers")
    if v274 then
        table.insert(vu272, { model = v274:Clone(), parent = v274.Parent })
        v274:Destroy()
    end
end
local function vu280()
    local v276, v277, v278 = ipairs(vu272)
    while true do
        local v279
        v278, v279 = v276(v277, v278)
        if v278 == nil then break end
        if v279.model.Parent == nil then v279.model.Parent = v279.parent end
    end
    vu272 = {}
end
Tabs.Robberies:AddToggle("RemoveMovingLasers", {
    Title = "Remove Lasers", Default = false,
    Callback = function(p281) if p281 then vu275() else vu280() end end
})
local vu282 = {}
local function vu285()
    local v283 = vu3:FindFirstChild("OilRig")
    local v284 = v283 and v283:FindFirstChild("Turrets")
    if v284 then
        table.insert(vu282, { model = v284:Clone(), parent = v284.Parent })
        v284:Destroy()
    end
end
local function vu290()
    local v286, v287, v288 = ipairs(vu282)
    while true do
        local v289
        v288, v289 = v286(v287, v288)
        if v288 == nil then break end
        if v289.model.Parent == nil then v289.model.Parent = v289.parent end
    end
    vu282 = {}
end
Tabs.Robberies:AddToggle("RemoveTurrets", {
    Title = "Remove Turrets", Default = false,
    Callback = function(p291) if p291 then vu285() else vu290() end end
})

Tabs.Robberies:AddSection("CargoShip")
local vu292 = {}
local function vu296()
    local v293 = vu3:FindFirstChild("CargoShip")
    if v293 then
        local v294 = v293:FindFirstChild("TurretBack")
        local v295 = v293:FindFirstChild("TurretFront")
        if v294 and v295 then
            table.insert(vu292, { back = v294:Clone(), front = v295:Clone(), parent = v294.Parent })
            v294:Destroy()
            v295:Destroy()
        end
    end
end
local function vu301()
    local v297, v298, v299 = ipairs(vu292)
    while true do
        local v300
        v299, v300 = v297(v298, v299)
        if v299 == nil then break end
        if v300.back.Parent == nil then v300.back.Parent = v300.parent end
        if v300.front.Parent == nil then v300.front.Parent = v300.parent end
    end
    vu292 = {}
end
Tabs.Robberies:AddToggle("RemoveTurretsCargoShip", {
    Title = "Remove Turrets", Default = false,
    Callback = function(p302) if p302 then vu296() else vu301() end end
})

Tabs.Robberies:AddSection("Airdrop")
local vu303 = nil
local function vu307(p304)
    local v305 = p304:FindFirstChild("Drop")
    local v306 = v305 and v305:FindFirstChild("NPCs")
    if v306 then
        vu303 = v306:Clone()
        v306:Destroy()
    end
end
local function vu308()
    if vu303 then
        vu303.Parent = workspace.Drop
        vu303 = nil
    end
end
Tabs.Robberies:AddToggle("DisableNPCs", {
    Title = "Remove NPCs", Default = false,
    Callback = function(p309) if p309 then vu307(workspace) else vu308() end end
})

-- // BACKGROUND LOOPS & LOGIC // --

-- LocalPlayer Speed & Nerf Equip Loop
task.spawn(function()
    RunService.RenderStepped:Connect(function()
        pcall(function()
            local char = LocalPlayer.Character
            if char and char:FindFirstChild("Humanoid") then
                char.Humanoid.WalkSpeed = state.localSpeed or 24
            end
            if state.nerfEquip then
                local ok, m = pcall(function() return require(ReplicatedStorage.Resource.Settings) end)
                if ok and m then
                    pcall(function()
                        if LocalPlayer.PlayerGui:FindFirstChild("GunShopGui") and LocalPlayer.PlayerGui.GunShopGui.Container.Container.Main.Container:FindFirstChild("Slider") then
                            local sld = LocalPlayer.PlayerGui.GunShopGui.Container.Container.Main.Container.Slider
                            if sld:FindFirstChild("Revolver") and sld:FindFirstChild("Pistol") then
                                sld.Revolver.Top.Icon.Image = m.Images["NerfRevolver"] or sld.Revolver.Top.Icon.Image
                                sld.Pistol.Top.Icon.Image = m.Images["NerfPistol"] or sld.Pistol.Top.Icon.Image
                            end
                        end
                        if LocalPlayer:FindFirstChild("Folder") then
                            if LocalPlayer.Folder:FindFirstChild("Pistol") then LocalPlayer.Folder.Pistol:SetAttribute("HotbarImageSrc", m.Images["NerfPistol"] or LocalPlayer.Folder.Pistol:GetAttribute("HotbarImageSrc")) end
                            if LocalPlayer.Folder:FindFirstChild("Revolver") then LocalPlayer.Folder.Revolver:SetAttribute("HotbarImageSrc", m.Images["NerfRevolver"] or LocalPlayer.Folder.Revolver:GetAttribute("HotbarImageSrc")) end
                        end
                    end)
                end
            end
        end)
    end)
end)

-- Infinite Jump
UserInputService.JumpRequest:Connect(function()
    if not state.infJump then return end
    local char = LocalPlayer.Character
    if not char then return end
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if humanoid and humanoid.Health > 0 then
        pcall(function()
            humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
        end)
    end
end)

-- NPC Aura Loop
task.spawn(function()
    while true do
        if state.npcAura then
            pcall(function()
                local myHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if not myHRP then return end
                if Workspace:FindFirstChild("Drop") and Workspace.Drop:FindFirstChild("NPCs") then
                    for _, npc in ipairs(Workspace.Drop.NPCs:GetChildren()) do
                        if Players:GetPlayerFromCharacter(npc) then continue end
                        if npc and npc:FindFirstChild("HumanoidRootPart") and npc:FindFirstChild("Humanoid") then
                            if (npc.HumanoidRootPart.Position - myHRP.Position).magnitude <= 300 then
                                pcall(function() npc.Humanoid.Health = 0 end)
                            end
                        end
                    end
                end
                if Workspace:FindFirstChild("OilRig") and Workspace.OilRig:FindFirstChild("GuardsFolder") then
                    for _, g in ipairs(Workspace.OilRig.GuardsFolder:GetChildren()) do
                        if Players:GetPlayerFromCharacter(g) then continue end
                        if g and g:FindFirstChild("HumanoidRootPart") and g:FindFirstChild("Humanoid") then
                            if (g.HumanoidRootPart.Position - myHRP.Position).magnitude <= 300 then
                                pcall(function() g.Humanoid.Health = 0 end)
                            end
                        end
                    end
                end
                if Workspace:FindFirstChild("MansionRobbery") and Workspace.MansionRobbery:FindFirstChild("GuardsFolder") then
                    for _, g in ipairs(Workspace.MansionRobbery.GuardsFolder:GetChildren()) do
                        if Players:GetPlayerFromCharacter(g) then continue end
                        if g and g:FindFirstChild("HumanoidRootPart") and g:FindFirstChild("Humanoid") then
                            if (g.HumanoidRootPart.Position - myHRP.Position).magnitude <= 300 then
                                pcall(function() g.Humanoid.Health = 0 end)
                            end
                        end
                    end
                end
            end)
        end
        task.wait(1)
    end
end)

-- Damage Detection for Priority
task.spawn(function()
    while true do
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("Humanoid") then
            local hum = char.Humanoid
            if lastHealth == nil then lastHealth = hum.Health end
            if hum.Health < lastHealth then
                lastDamageTime = tick()
                local hrp = char:FindFirstChild("HumanoidRootPart")
                if hrp then lastDamagePosition = hrp.Position end
            end
            lastHealth = hum.Health
        end
        task.wait(0.25)
    end
end)

-- Pistol Loss Watcher
task.spawn(function()
    local folder = LocalPlayer:FindFirstChild("Folder", 10)
    if folder then
        folder.ChildRemoved:Connect(function(child)
            if child.Name == "Pistol" then
                state.hasPistol = false
                pushLog("Pistol lost from inventory")
                if state.killAura or state.silentAim then ensurePistol() end
            end
        end)
    end
    while true do
        if state.hasPistol and not (LocalPlayer:FindFirstChild("Folder") and LocalPlayer.Folder:FindFirstChild("Pistol")) then
            state.hasPistol = false
            pushLog("Pistol no longer detected")
            if state.killAura or state.silentAim then ensurePistol() end
        end
        task.wait(PISTOL_CHECK_INTERVAL)
    end
end)

if LocalPlayer:FindFirstChild("Folder") and LocalPlayer.Folder:FindFirstChild("Pistol") then
    state.hasPistol = true
    pushLog("Pistol present on load")
end

-- // ESP MODULE // --
local env = getgenv and getgenv() or _G
env.ESPSettings = env.ESPSettings or {
    master = false, box = true, chams = true, tracers = true, health = true, distance = true, teamFilter = true,
    teamNames = { police = "Police", criminal = "Criminal", prisoner = "Prisoner" }
}
env.ESPAPI = env.ESPAPI or {}

local boxes = {}
local highlights = {}
local beamTracers = {}
local healthBars = {}
local distanceLabels = {}

local function getPlayerColor(plr)
    local tn = env.ESPSettings.teamNames
    local tstr = teamString(plr)
    if tstr == tn.police then return Color3.fromRGB(0, 122, 255)
    elseif tstr == tn.criminal then return Color3.fromRGB(255, 40, 40)
    elseif tstr == tn.prisoner then return Color3.fromRGB(200, 200, 200)
    else return plr.TeamColor and plr.TeamColor.Color or Color3.fromRGB(0, 255, 0)
    end
end

local function shouldShowPlayer(plr)
    if not env.ESPSettings.teamFilter then return true end
    local tn = env.ESPSettings.teamNames
    local myTeam = LocalPlayer.Team and tostring(LocalPlayer.Team) or ""
    local theirTeam = plr.Team and tostring(plr.Team) or ""
    if myTeam == tn.police then return theirTeam == tn.criminal end
    if myTeam == tn.criminal or myTeam == tn.prisoner then return theirTeam == tn.police end
    return true
end

local function safeDestroy(inst) if inst and inst.Destroy then pcall(function() inst:Destroy() end) end end
local function safeRemoveDrawing(d) if d and d.Remove then pcall(function() d:Remove() end) end end

local DrawingAvailable = pcall(function() return Drawing end)
local function createBoxDrawing()
    if not DrawingAvailable then return nil end
    local box = Drawing.new("Square")
    box.Visible = false; box.Filled = false; box.Thickness = 2; box.Transparency = 1
    return box
end

local function createHealthDrawing()
    if not DrawingAvailable then return nil end
    local hb = {}
    hb.background = Drawing.new("Square")
    hb.background.Visible = false; hb.background.Filled = true; hb.background.Transparency = 1; hb.background.Color = Color3.fromRGB(0,0,0)
    hb.health = Drawing.new("Square")
    hb.health.Visible = false; hb.health.Filled = true; hb.health.Transparency = 1; hb.health.Color = Color3.fromRGB(0,255,0)
    return hb
end

local function createDistanceLabel()
    if not DrawingAvailable then return nil end
    local txt = Drawing.new("Text")
    txt.Visible = false; txt.Center = true; txt.Outline = true; txt.Size = 16; txt.Font = Drawing.Fonts.UI; txt.Color = Color3.fromRGB(255,255,255)
    return txt
end

local function addHighlight(plr)
    if highlights[plr] then return end
    if not plr.Character then return end
    local h = Instance.new("Highlight")
    h.Adornee = plr.Character
    h.FillColor = getPlayerColor(plr)
    h.FillTransparency = 0.5
    h.Parent = game.CoreGui
    highlights[plr] = h
end
local function removeHighlight(plr) if highlights[plr] then safeDestroy(highlights[plr]) highlights[plr] = nil end end

local function createBeamFor(plr)
    if beamTracers[plr] then destroyBeamFor(plr) end
    if not plr.Character then return end
    local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
    local localHRP = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not hrp or not localHRP then return end
    local att0 = Instance.new("Attachment"); att0.Parent = localHRP
    local att1 = Instance.new("Attachment"); att1.Parent = hrp
    local beam = Instance.new("Beam"); beam.Attachment0 = att0; beam.Attachment1 = att1; beam.Width0 = 0.05; beam.Width1 = 0.05; beam.Color = ColorSequence.new(getPlayerColor(plr)); beam.FaceCamera = true; beam.Parent = workspace
    beamTracers[plr] = {Attachment0 = att0, Attachment1 = att1, Beam = beam}
end
function destroyBeamFor(plr)
    local d = beamTracers[plr]
    if d then safeDestroy(d.Beam); safeDestroy(d.Attachment0); safeDestroy(d.Attachment1); beamTracers[plr] = nil end
end

task.spawn(function()
    RunService.RenderStepped:Connect(function()
        if not env.ESPSettings.master then
            for _, box in pairs(boxes) do box.Visible = false end
            for _, d in pairs(beamTracers) do if d.Beam then d.Beam.Enabled = false end end
            for _, hb in pairs(healthBars) do hb.background.Visible = false; hb.health.Visible = false end
            for _, lbl in pairs(distanceLabels) do lbl.Visible = false end
            for plr, _ in pairs(highlights) do removeHighlight(plr) end
            return
        end

        for _, plr in pairs(Players:GetPlayers()) do
            if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") and shouldShowPlayer(plr) then
                local hrp = plr.Character.HumanoidRootPart
                local rootPos, onScreen = Camera:WorldToViewportPoint(hrp.Position)
                local dist = (Camera.CFrame.Position - hrp.Position).Magnitude

                if env.ESPSettings.chams then
                    if not highlights[plr] then addHighlight(plr) end
                    if highlights[plr] then highlights[plr].FillColor = getPlayerColor(plr) highlights[plr].Adornee = plr.Character end
                else
                    removeHighlight(plr)
                end

                if env.ESPSettings.box and DrawingAvailable then
                    if not boxes[plr] then boxes[plr] = createBoxDrawing() end
                    if onScreen then
                        local sizeY = (1500 / dist) * 1.3
                        local sizeX = sizeY * 1.0
                        boxes[plr].Size = Vector2.new(sizeX, sizeY)
                        boxes[plr].Position = Vector2.new(rootPos.X - sizeX/2, rootPos.Y - sizeY/2)
                        boxes[plr].Color = getPlayerColor(plr)
                        boxes[plr].Visible = true
                    else
                        boxes[plr].Visible = false
                    end
                elseif boxes[plr] then
                    boxes[plr].Visible = false
                end

                if env.ESPSettings.tracers then
                    if not beamTracers[plr] then createBeamFor(plr) end
                    if beamTracers[plr] and beamTracers[plr].Beam then
                        beamTracers[plr].Beam.Color = ColorSequence.new(getPlayerColor(plr))
                        beamTracers[plr].Beam.Enabled = true
                    end
                elseif beamTracers[plr] then
                    beamTracers[plr].Beam.Enabled = false
                end

                if env.ESPSettings.health and DrawingAvailable then
                    if not healthBars[plr] then healthBars[plr] = createHealthDrawing() end
                    if onScreen then
                        local humanoid = plr.Character:FindFirstChild("Humanoid")
                        if humanoid then
                            local sizeY = (1500 / dist) * 1.3
                            local barH = sizeY
                            local barX = (rootPos.X - (sizeY * 1.0 / 2)) - 6 - 5
                            local barY = rootPos.Y - sizeY/2
                            healthBars[plr].background.Size = Vector2.new(4, barH)
                            healthBars[plr].background.Position = Vector2.new(barX, barY)
                            healthBars[plr].background.Visible = true
                            
                            local pct = math.clamp(humanoid.Health / humanoid.MaxHealth, 0, 1)
                            local fillH = barH * pct
                            healthBars[plr].health.Size = Vector2.new(4, fillH)
                            healthBars[plr].health.Position = Vector2.new(barX, barY + (barH - fillH))
                            healthBars[plr].health.Visible = true
                            healthBars[plr].health.Color = Color3.fromHSV(pct * 0.3, 1, 1)
                        end
                    else
                        healthBars[plr].background.Visible = false
                        healthBars[plr].health.Visible = false
                    end
                elseif healthBars[plr] then
                    healthBars[plr].background.Visible = false; healthBars[plr].health.Visible = false
                end
                
                if env.ESPSettings.distance and DrawingAvailable then
                    if not distanceLabels[plr] then distanceLabels[plr] = createDistanceLabel() end
                    if onScreen then
                        distanceLabels[plr].Position = Vector2.new(rootPos.X, rootPos.Y + ((1500/dist)*1.3)/2 + 5)
                        distanceLabels[plr].Text = math.floor(dist) .. " studs"
                        distanceLabels[plr].Color = getPlayerColor(plr)
                        distanceLabels[plr].Visible = true
                    else
                        distanceLabels[plr].Visible = false
                    end
                elseif distanceLabels[plr] then
                    distanceLabels[plr].Visible = false
                end

            else
                removeHighlight(plr)
                if boxes[plr] then boxes[plr].Visible = false end
                if beamTracers[plr] and beamTracers[plr].Beam then beamTracers[plr].Beam.Enabled = false end
                if healthBars[plr] then healthBars[plr].background.Visible = false; healthBars[plr].health.Visible = false end
                if distanceLabels[plr] then distanceLabels[plr].Visible = false end
            end
        end
    end)
end)

env.ESPAPI.Enable = function() env.ESPSettings.master = true end
env.ESPAPI.Disable = function() env.ESPSettings.master = false end

SaveManager:SetLibrary(Fluent)
InterfaceManager:SetLibrary(Fluent)
SaveManager:IgnoreThemeSettings()
SaveManager:SetIgnoreIndexes({})
InterfaceManager:BuildInterfaceSection(Tabs.Settings)
SaveManager:BuildConfigSection(Tabs.Settings)
Window:SelectTab(1)
print("[SmileB] Execution Finished. UI should appear.")
pushLog("Script Loaded Successfully")
