local Players = game:GetService("Players")
local player = Players.LocalPlayer
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- =========================
-- GLOBAL TOGGLES
-- =========================
getgenv().keycardEnabled = getgenv().keycardEnabled or false
getgenv().killAuraEnabled = getgenv().killAuraEnabled or false
getgenv().silentAimEnabled = getgenv().silentAimEnabled or false
getgenv().safeModeEnabled = getgenv().safeModeEnabled or false

-- =========================
-- SPLASH SCREEN OVERLAY
-- =========================
local SplashGui = Instance.new("ScreenGui")
SplashGui.Parent = player:WaitForChild("PlayerGui")
SplashGui.ResetOnSpawn = false
SplashGui.IgnoreGuiInset = true

local SplashFrame = Instance.new("Frame")
SplashFrame.Size = UDim2.new(1, 0, 1, 0)
SplashFrame.Position = UDim2.new(0, 0, 0, 0)
SplashFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
SplashFrame.BackgroundTransparency = 0.1
SplashFrame.BorderSizePixel = 0
SplashFrame.Parent = SplashGui

local SplashTitle = Instance.new("TextLabel")
SplashTitle.Size = UDim2.new(1, 0, 0, 80)
SplashTitle.Position = UDim2.new(0, 0, 0.1, 0)
SplashTitle.BackgroundTransparency = 1
SplashTitle.Text = "Smile B (right ctrl to toggle)"
SplashTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
SplashTitle.TextScaled = true
SplashTitle.Font = Enum.Font.SourceSansBold
SplashTitle.Parent = SplashFrame

local SplashDesc = Instance.new("TextLabel")
SplashDesc.Size = UDim2.new(0.9, 0, 0, 120)
SplashDesc.Position = UDim2.new(0.05, 0, 0.3, 0)
SplashDesc.BackgroundTransparency = 1
SplashDesc.Text = [[This script is designed for REALISTIC gameplay:

âœ… Keeps you alive from enemies (KillAura + Silent Aim)
âœ… Free keycard for faster prison escape
âœ… SafeMode: Only activates when enemies are CLOSE (â‰¤100 studs)

NO crazy fly/hack speed/ESP - just survival tools!]]
SplashDesc.TextColor3 = Color3.fromRGB(200, 200, 200)
SplashDesc.TextScaled = true
SplashDesc.Font = Enum.Font.SourceSans
SplashDesc.TextWrapped = true
SplashDesc.Parent = SplashFrame

local SplashControls = Instance.new("TextLabel")
SplashControls.Size = UDim2.new(0.9, 0, 0, 60)
SplashControls.Position = UDim2.new(0.05, 0, 0.6, 0)
SplashControls.BackgroundTransparency = 1
SplashControls.Text = [[Chat Commands:
!keycard - Toggle free keycard
!killaura - Auto-shoot enemies (1000 studs)
!silentaim - Aim assist (1000 studs) 
!safemode - SilentAim and Killaura but KillAura only â‰¤100 studs

Right Ctrl = Hide/Show UI]]
SplashControls.TextColor3 = Color3.fromRGB(100, 255, 100)
SplashControls.TextScaled = true
SplashControls.Font = Enum.Font.SourceSansBold
SplashControls.TextWrapped = true
SplashControls.Parent = SplashFrame

local CountdownLabel = Instance.new("TextLabel")
CountdownLabel.Size = UDim2.new(0.9, 0, 0, 50)
CountdownLabel.Position = UDim2.new(0.05, 0, 0.85, 0)
CountdownLabel.BackgroundTransparency = 1
CountdownLabel.Text = "Click UNDERSTOOD in 5s or script will reload..."
CountdownLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
CountdownLabel.TextScaled = true
CountdownLabel.Font = Enum.Font.SourceSansBold
CountdownLabel.Parent = SplashFrame

local UnderstoodButton = Instance.new("TextButton")
UnderstoodButton.Size = UDim2.new(0.4, 0, 0, 50)
UnderstoodButton.Position = UDim2.new(0.3, 0, 0.92, 0)
UnderstoodButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
UnderstoodButton.Text = "UNDERSTOOD"
UnderstoodButton.TextColor3 = Color3.fromRGB(255, 255, 255)
UnderstoodButton.TextScaled = true
UnderstoodButton.Font = Enum.Font.SourceSansBold
UnderstoodButton.Parent = SplashFrame

-- Countdown logic
local countdown = 60
local connection
connection = RunService.Heartbeat:Connect(function()
    countdown = countdown - 1/60
    CountdownLabel.Text = string.format("Click UNDERSTOOD in %.1fs", math.max(0, countdown))
    
    if countdown <= 0 then
        SplashGui:Destroy()
        connection:Disconnect()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/yourusername/smileb/main/script.lua"))() -- Replace with your script raw link
    end
end)

UnderstoodButton.MouseButton1Click:Connect(function()
    SplashGui:Destroy()
    connection:Disconnect()
end)

-- =========================
-- NEAREST ENEMY FUNCTION
-- =========================
local function getNearestEnemy(maxDist)
    maxDist = maxDist or 1000
    local nearestDistance, nearestEnemy = maxDist, nil
    
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
        return nil, maxDist
    end
    
    local myTeam = tostring(player.Team)
    
    for _, v in pairs(Players:GetPlayers()) do
        if v == player then continue end
        
        local theirTeam = tostring(v.Team)
        local validTarget = false
        
        if myTeam == "Police" and theirTeam == "Criminal" then
            validTarget = true
        elseif (myTeam == "Criminal" or myTeam == "Prisoner") and theirTeam == "Police" then
            validTarget = true
        end
        
        if validTarget and v.Character and v.Character:FindFirstChild("HumanoidRootPart") then
            local dist = (v.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
            if dist < nearestDistance then
                nearestDistance, nearestEnemy = dist, v
            end
        end
    end
    
    return nearestEnemy, nearestDistance
end

-- Wait for splash to close before main script
repeat task.wait() until not SplashGui.Parent

-- =========================
-- MAIN UI SETUP
-- =========================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = player:WaitForChild("PlayerGui")
ScreenGui.ResetOnSpawn = false

local StatusFrame = Instance.new("Frame")
StatusFrame.Size = UDim2.new(0, 200, 0, 120)
StatusFrame.Position = UDim2.new(0, 10, 0, 10)
StatusFrame.BackgroundTransparency = 0.5
StatusFrame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
StatusFrame.BorderSizePixel = 0
StatusFrame.Parent = ScreenGui

local TitleBar = Instance.new("TextLabel")
TitleBar.Size = UDim2.new(1, 0, 0, 25)
TitleBar.BackgroundTransparency = 0
TitleBar.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
TitleBar.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleBar.Text = "ðŸ›¡ï¸ Smile B ðŸ›¡ï¸"
TitleBar.Font = Enum.Font.SourceSansBold
TitleBar.TextScaled = true
TitleBar.Parent = StatusFrame

local LabelContainer = Instance.new("Frame")
LabelContainer.Size = UDim2.new(1, 0, 1, -25)
LabelContainer.Position = UDim2.new(0, 0, 0, 25)
LabelContainer.BackgroundTransparency = 1
LabelContainer.Parent = StatusFrame

local StatusTexts = {}
local function createStatusText(name, index)
    local text = Instance.new("TextLabel")
    text.Size = UDim2.new(1, 0, 0, 25)
    text.Position = UDim2.new(0, 0, 0, 25 * (index - 1))
    text.BackgroundTransparency = 1
    text.TextColor3 = Color3.fromRGB(255, 255, 255)
    text.TextStrokeTransparency = 0
    text.TextScaled = true
    text.Font = Enum.Font.SourceSansBold
    text.Text = name .. ": OFF"
    text.Parent = LabelContainer
    StatusTexts[name] = text
end

createStatusText("Keycard", 1)
createStatusText("KillAura", 2)
createStatusText("SilentAim", 3)
createStatusText("SafeMode", 4)

-- =========================
-- UI FUNCTIONS
-- =========================
local uiVisible = true

local function updateUIVisibility()
    StatusFrame.Visible = uiVisible
end

local function updateStatusTexts()
    StatusTexts["Keycard"].Text = "Keycard: " .. (getgenv().keycardEnabled and "ON" or "OFF")
    
    local _, dist100 = getNearestEnemy(100)
    local safeKillActive = getgenv().safeModeEnabled and dist100 <= 100
    local killAuraActive = getgenv().killAuraEnabled or safeKillActive
    StatusTexts["KillAura"].Text = "KillAura: " .. (killAuraActive and "ON" or "OFF")
    
    local silentAimActive = getgenv().silentAimEnabled or getgenv().safeModeEnabled
    StatusTexts["SilentAim"].Text = "SilentAim: " .. (silentAimActive and "ON" or "OFF")
    
    StatusTexts["SafeMode"].Text = "SafeMode: " .. (getgenv().safeModeEnabled and "ON" or "OFF")
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.KeyCode == Enum.KeyCode.RightControl then
        uiVisible = not uiVisible
        updateUIVisibility()
    end
end)

RunService.Heartbeat:Connect(function()
    if uiVisible and getgenv().safeModeEnabled then
        updateStatusTexts()
    end
end)

updateStatusTexts()
updateUIVisibility()

-- =========================
-- KEYCARD
-- =========================
local keycardModule = ReplicatedStorage:WaitForChild("Game"):WaitForChild("PlayerUtils")
local keycardUtils = require(keycardModule)
local originalHasKey = keycardUtils.hasKey

local function updateKeycard()
    if getgenv().keycardEnabled then
        keycardUtils.hasKey = function() return true end
    else
        keycardUtils.hasKey = originalHasKey
    end
end

-- =========================
-- AIM & KILL AURA LOGIC
-- =========================
getgenv().killAuraLoaded = getgenv().killAuraLoaded or false
if not getgenv().killAuraLoaded then
    getgenv().killAuraLoaded = true
    
    local raycastModule = require(ReplicatedStorage:WaitForChild("Module"):WaitForChild("RayCast"))
    local originalRay = raycastModule.RayIgnoreNonCollideWithIgnoreList
    
    raycastModule.RayIgnoreNonCollideWithIgnoreList = function(...)
        local args = {originalRay(...)}
        local env = getfenv(2)
        local scriptName = tostring(env and env.script or "")
        
        if not (scriptName == "BulletEmitter" or scriptName == "Taser") then
            return unpack(args)
        end
        
        local aimActive = getgenv().silentAimEnabled or getgenv().safeModeEnabled or getgenv().killAuraEnabled
        if not aimActive then
            return unpack(args)
        end
        
        local nearestEnemy, distance = getNearestEnemy(1000)
        if not nearestEnemy or not nearestEnemy.Character or not nearestEnemy.Character:FindFirstChild("HumanoidRootPart") then
            return unpack(args)
        end
        
        local targetHRP = nearestEnemy.Character.HumanoidRootPart
        local shouldAim = false
        
        if getgenv().silentAimEnabled then
            shouldAim = true
        end
        
        if getgenv().safeModeEnabled then
            shouldAim = true
        end
        
        if getgenv().killAuraEnabled and distance <= 1000 then
            shouldAim = true
        end
        
        if shouldAim then
            args[1] = targetHRP
            args[2] = targetHRP.Position
        end
        
        return unpack(args)
    end
    
    spawn(function()
        while task.wait(0.5) do
            if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then continue end
            
            local shouldShoot = getgenv().killAuraEnabled
            
            if getgenv().safeModeEnabled then
                local _, dist = getNearestEnemy(100)
                shouldShoot = dist <= 100
            end
            
            if shouldShoot then
                local nearestEnemy, dist = getNearestEnemy(1000)
                if nearestEnemy and dist <= 1000 and nearestEnemy.Character and nearestEnemy.Character:FindFirstChild("Humanoid") and nearestEnemy.Character.Humanoid.Health > 0 then
                    
                    local folder = player:FindFirstChild("Folder")
                    if folder then
                        local pistol = folder:FindFirstChild("Pistol")
                        if not pistol then
                            local givers = workspace:FindFirstChild("Givers")
                            if givers then
                                local giver = givers:GetChildren()[17]
                                if giver and giver:FindFirstChild("ClickDetector") then
                                    fireclickdetector(giver.ClickDetector)
                                    task.wait(0.2)
                                end
                            end
                        end
                        pistol = folder:FindFirstChild("Pistol")
                        
                        if pistol then
                            pistol.InventoryEquipRemote:FireServer(true)
                            
                            while task.wait() do
                                local currentDist = (nearestEnemy.Character.HumanoidRootPart.Position - player.Character.HumanoidRootPart.Position).Magnitude
                                if not pistol or not nearestEnemy.Character or not nearestEnemy.Character:FindFirstChild("HumanoidRootPart") 
                                    or currentDist > 1000 or nearestEnemy.Character.Humanoid.Health <= 0 then
                                    break
                                end
                                
                                local itemSystem = require(ReplicatedStorage.Game:WaitForChild("ItemSystem"):WaitForChild("ItemSystem"))
                                local currentGun = itemSystem.GetLocalEquipped()
                                if currentGun then
                                    require(ReplicatedStorage.Game:WaitForChild("Item"):WaitForChild("Gun"))._attemptShoot(currentGun)
                                end
                            end
                            
                            pistol.InventoryEquipRemote:FireServer(false)
                        end
                    end
                end
            end
        end
    end)
end

-- =========================
-- CHAT COMMANDS
-- =========================
TextChatService.OnIncomingMessage = function(message)
    if not message.TextSource or message.TextSource.UserId ~= player.UserId then
        return message
    end
    
    local cmd = message.Text:lower():gsub("%s+", "")
    
    if cmd == "!keycard" then
        getgenv().keycardEnabled = not getgenv().keycardEnabled
        updateKeycard()
        updateStatusTexts()
        
    elseif cmd == "!killaura" then
        getgenv().killAuraEnabled = not getgenv().killAuraEnabled
        updateStatusTexts()
        
    elseif cmd == "!silentaim" then
        getgenv().silentAimEnabled = not getgenv().silentAimEnabled
        updateStatusTexts()
        
    elseif cmd == "!safemode" then
        getgenv().safeModeEnabled = not getgenv().safeModeEnabled
        updateStatusTexts()
    end
    
    return message
end

-- Initial setup
updateKeycard()
updateStatusTexts()
